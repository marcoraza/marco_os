<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar de Noticias — Marco OS</title>
<style>*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#111;--bg2:#1a1a1a;--bg3:#222;--bg4:#282828;
  --sep:rgba(255,255,255,.06);--sep2:rgba(255,255,255,.1);--sep3:rgba(255,255,255,.18);
  --text:#e2e2e2;--dim:#888;--dim2:#555;--dim3:#333;
  --green:#4ade80;--blue:#60a5fa;--yellow:#fbbf24;--orange:#fb923c;
  --purple:#c084fc;--red:#f87171;--gold:#fcd34d;
  --overlay:rgba(0,0,0,.72)
}
html,body{min-height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Inter','Segoe UI',sans-serif;font-size:13px;line-height:1.5}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px}
a{color:inherit;text-decoration:none}
.page{max-width:1200px;margin:0 auto;padding:28px 24px 100px}

/* ── HEADER ─────────────────────────────────────────────────────────────── */
.header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px}
.header h1{font-size:21px;font-weight:700;letter-spacing:-.4px}
.h-badge{font-size:10px;padding:2px 7px;border-radius:20px;font-weight:600;letter-spacing:.04em;margin-left:8px;vertical-align:middle}
.h-badge.global{background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.h-badge.br{background:rgba(74,222,128,.1);color:var(--green);border:1px solid rgba(74,222,128,.2)}
.h-badge.tech{background:rgba(96,165,250,.1);color:var(--blue);border:1px solid rgba(96,165,250,.2)}
.h-badge.crypto{background:rgba(252,211,77,.1);color:var(--gold);border:1px solid rgba(252,211,77,.2)}
.header-sub{font-size:11px;color:var(--dim);margin-top:3px}
.header-right{display:flex;align-items:center;gap:12px;padding-top:2px}
.status-pill{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--green)}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 2.4s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.clock{font-size:11px;color:var(--dim);font-variant-numeric:tabular-nums}

/* ── TABS ────────────────────────────────────────────────────────────────── */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--sep);margin-bottom:22px}
.tab{padding:9px 18px;font-size:12px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--dim);transition:all .15s;display:flex;align-items:center;gap:5px;margin-bottom:-1px;white-space:nowrap}
.tab:hover{color:var(--text)}
.tab.active{color:var(--text);border-bottom-color:var(--green)}
.tab-count{font-size:10px;background:var(--bg3);border-radius:10px;padding:1px 5px;color:var(--dim2);transition:all .2s}
.tab.active .tab-count{background:rgba(74,222,128,.12);color:var(--green)}

/* ── MAIN LAYOUT ─────────────────────────────────────────────────────────── */
.main-layout{display:flex;gap:28px;align-items:flex-start}
.col-main{flex:1;min-width:0}
.col-side{width:288px;flex-shrink:0;position:sticky;top:24px;max-height:calc(100vh - 48px);overflow-y:auto}
.col-side::-webkit-scrollbar{width:3px}

/* ── STATS ───────────────────────────────────────────────────────────────── */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--sep);border:1px solid var(--sep);border-radius:10px;overflow:hidden;margin-bottom:16px}
.stat{padding:12px 14px;background:var(--bg2)}
.stat-val{font-size:20px;font-weight:700;line-height:1;font-variant-numeric:tabular-nums}
.stat-lbl{font-size:10px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:.05em}

/* ── TOOLBAR ─────────────────────────────────────────────────────────────── */
.toolbar{display:flex;align-items:center;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.toolbar-r{margin-left:auto;display:flex;align-items:center;gap:6px}
.btn{display:inline-flex;align-items:center;gap:4px;padding:6px 11px;border-radius:6px;font-size:11px;font-weight:500;cursor:pointer;transition:all .15s;border:1px solid var(--sep2);background:var(--bg2);color:var(--dim);white-space:nowrap}
.btn:hover{color:var(--text);border-color:var(--sep3)}
.btn.primary{background:rgba(74,222,128,.08);border-color:rgba(74,222,128,.22);color:var(--green)}
.btn.primary:hover{background:rgba(74,222,128,.14)}
.btn:disabled{opacity:.4;cursor:default;pointer-events:none}
.sort-btns{display:flex}
.sort-btn{padding:6px 11px;font-size:11px;cursor:pointer;border:1px solid var(--sep2);background:var(--bg2);color:var(--dim);transition:all .15s;white-space:nowrap}
.sort-btn:first-child{border-radius:6px 0 0 6px}
.sort-btn:last-child{border-radius:0 6px 6px 0;margin-left:-1px}
.sort-btn:not(:first-child):not(:last-child){margin-left:-1px}
.sort-btn.active{background:var(--bg3);color:var(--text);border-color:var(--sep3)}
.search{display:flex;align-items:center;gap:5px;background:var(--bg2);border:1px solid var(--sep2);border-radius:6px;padding:5px 10px}
.search input{background:none;border:none;outline:none;color:var(--text);font-size:11px;width:130px}
.search input::placeholder{color:var(--dim2)}
#read-count{font-size:10px;color:var(--dim2);padding:2px 7px;background:var(--bg3);border-radius:10px;display:none}

/* ── SRC FILTERS ─────────────────────────────────────────────────────────── */
.src-row{display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap}
.sf{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--sep);background:transparent;color:var(--dim);transition:all .15s;user-select:none}
.sf:hover{color:var(--text);border-color:var(--sep2)}
.sf.on{background:var(--bg2);border-color:var(--sep2);color:var(--text)}
.src-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* ── ERROR ───────────────────────────────────────────────────────────────── */
.error-banner{background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.18);border-radius:6px;padding:8px 12px;font-size:11px;color:var(--red);margin-bottom:12px;display:none;align-items:center;gap:7px}
.error-banner.on{display:flex}

/* ── SECTION LABEL ───────────────────────────────────────────────────────── */
.section-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim2);padding:14px 0 10px;border-top:1px solid var(--sep);margin-top:6px;display:flex;align-items:center;gap:8px}
.section-label::after{content:'';flex:1;height:1px;background:var(--sep)}

/* ── MARCO SCORE BADGE ───────────────────────────────────────────────────── */
.marco-score{display:inline-flex;align-items:center;font-size:10px;padding:1px 5px;border-radius:7px;font-weight:600}
.marco-score.hi{background:rgba(74,222,128,.12);color:var(--green);border:1px solid rgba(74,222,128,.2)}
.marco-score.mid{background:rgba(251,191,36,.08);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.marco-score.lo{color:var(--dim2)}
.ms-badge{font-size:9px;padding:1px 4px}

/* ── HERO SECTION ────────────────────────────────────────────────────────── */
.hero-section{display:flex;flex-direction:column;gap:8px;margin-bottom:6px}
.hero-card{background:var(--bg2);border:1px solid var(--sep);border-radius:12px;padding:0;cursor:pointer;transition:background .12s,border-color .12s;overflow:hidden;border-left:3px solid var(--sep2)}
.hero-card:hover{background:#1d1d1d;border-color:var(--sep2)}
.hero-card.hot{border-left-color:var(--red)}
.hero-card.rising{border-left-color:var(--yellow)}
.hero-card.notable{border-left-color:var(--blue)}
.hero-inner{display:flex;gap:0;align-items:stretch}
.hero-thumb{width:100px;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--bg3)}
.hero-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.hero-body{flex:1;padding:16px 18px;min-width:0}
.hero-eyebrow{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.hero-topic{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em}
.hero-src-lbl{font-size:11px;color:var(--dim2)}
.hero-title{font-size:15px;font-weight:600;line-height:1.4;color:var(--text);margin-bottom:8px}
.hero-preview{font-size:12px;color:var(--dim);line-height:1.7;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* ── GRID SECTION ────────────────────────────────────────────────────────── */
.grid-section{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:6px}
.grid-card{background:var(--bg2);border:1px solid var(--sep);border-radius:10px;cursor:pointer;transition:background .12s,border-color .12s;overflow:hidden;display:flex;flex-direction:column}
.grid-card:hover{background:#1d1d1d;border-color:var(--sep2)}
.grid-card.hot .grid-thumb-wrap::after{content:'HOT';position:absolute;top:7px;left:7px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;letter-spacing:.05em}
.grid-card.rising .grid-thumb-wrap::after{content:'RISING';position:absolute;top:7px;left:7px;background:var(--yellow);color:#111;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;letter-spacing:.05em}
.grid-thumb-wrap{position:relative;height:110px;overflow:hidden;background:var(--bg3);flex-shrink:0}
.grid-thumb-wrap img,.grid-thumb-wrap div{width:100%;height:100%}
.grid-thumb-wrap img{object-fit:cover;display:block}
.grid-body{padding:11px 12px;flex:1;display:flex;flex-direction:column;gap:5px}
.grid-eyebrow{display:flex;align-items:center;gap:5px}
.grid-src{font-size:10px;color:var(--dim2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.grid-title{font-size:12px;font-weight:500;line-height:1.45;color:var(--text);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;flex:1}
.grid-meta{font-size:10px;color:var(--dim2)}

/* ── COMPACT LIST ────────────────────────────────────────────────────────── */
.compact-list{display:flex;flex-direction:column;gap:2px}
.compact-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .1s;background:var(--bg2);border:1px solid transparent}
.compact-item:hover{background:#1d1d1d;border-color:var(--sep)}
.compact-thumb{flex-shrink:0;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.compact-body{flex:1;min-width:0}
.compact-title{font-size:12px;font-weight:500;line-height:1.4;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.compact-meta{font-size:10px;color:var(--dim2);margin-top:2px}
.compact-dot-wrap{flex-shrink:0}
.compact-dot{width:7px;height:7px;border-radius:50%}
.compact-dot.hot{background:var(--red)}
.compact-dot.rising{background:var(--yellow)}
.compact-dot.notable{background:var(--dim2)}

/* ── READ ────────────────────────────────────────────────────────────────── */
.is-read{opacity:.38}
.is-read:hover{opacity:.65;transition:opacity .15s}

/* ── STATES ──────────────────────────────────────────────────────────────── */
.feed-loading{display:flex;align-items:center;justify-content:center;gap:10px;padding:56px 20px;color:var(--dim);font-size:12px}
.spin{animation:spin .7s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.feed-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:56px 20px;gap:8px;color:var(--dim);font-size:12px}

/* ── SIDEBAR ─────────────────────────────────────────────────────────────── */
.side-section{margin-bottom:24px}
.side-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--dim2);margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--sep)}

/* ── TOP 10 ──────────────────────────────────────────────────────────────── */
.top10-item{display:flex;align-items:flex-start;gap:8px;padding:8px 6px;border-radius:6px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--sep)}
.top10-item:last-child{border-bottom:none}
.top10-item:hover{background:rgba(255,255,255,.03)}
.top10-rank{font-size:12px;font-weight:800;width:18px;flex-shrink:0;color:var(--dim2);font-variant-numeric:tabular-nums;padding-top:1px}
.top10-rank.r1{color:var(--gold)}
.top10-rank.r2{color:#bbb}
.top10-rank.r3{color:var(--orange)}
.top10-title{font-size:11px;font-weight:500;line-height:1.4;flex:1;color:var(--text)}
.top10-meta{display:flex;align-items:center;gap:5px;margin-top:3px;flex-wrap:wrap}
.top10-score{font-size:10px;color:var(--dim2)}

/* ── HEAT MAP ────────────────────────────────────────────────────────────── */
.heat-row{display:flex;gap:5px;flex-wrap:wrap}
.heat-tag{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid transparent;transition:all .15s;user-select:none;opacity:.72}
.heat-tag:hover,.heat-tag.active{opacity:1}

/* ── DRAWER ──────────────────────────────────────────────────────────────── */
.drawer-overlay{position:fixed;inset:0;background:var(--overlay);z-index:100;opacity:0;pointer-events:none;transition:opacity .2s}
.drawer-overlay.on{opacity:1;pointer-events:all}
.drawer{position:fixed;top:0;right:-520px;width:500px;max-width:95vw;height:100vh;background:var(--bg2);border-left:1px solid var(--sep2);z-index:101;display:flex;flex-direction:column;transition:right .25s cubic-bezier(.4,0,.2,1)}
.drawer.on{right:0}
.drawer-head{display:flex;align-items:flex-start;gap:12px;padding:18px 18px 14px;border-bottom:1px solid var(--sep);flex-shrink:0}
.drawer-close{background:none;border:none;color:var(--dim);cursor:pointer;font-size:18px;line-height:1;transition:color .15s;margin-left:auto;flex-shrink:0;padding:2px 4px}
.drawer-close:hover{color:var(--text)}
.drawer-title{font-size:14px;font-weight:600;line-height:1.4;margin-bottom:4px}
.drawer-sub{font-size:11px;color:var(--dim);display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.drawer-body{flex:1;overflow-y:auto;padding:18px}
.dr-s{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--sep)}
.dr-s:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.dr-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--dim2);margin-bottom:8px}
.dr-text{font-size:12px;color:var(--dim);line-height:1.8}
.dr-frank{font-size:12px;color:var(--text);line-height:1.75;background:rgba(74,222,128,.04);border:1px solid rgba(74,222,128,.1);border-radius:6px;padding:12px 14px}
.dr-frank.loading{color:var(--dim);font-style:italic}
.dr-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px}
.dr-meta-item{display:flex;flex-direction:column;gap:2px}
.dr-meta-item span:first-child{font-size:10px;color:var(--dim2)}
.drawer-foot{padding:12px 18px;border-top:1px solid var(--sep);display:flex;align-items:center;gap:7px;flex-shrink:0}
.btn-ext{text-decoration:none;display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;font-size:11px;border:1px solid var(--sep2);background:var(--bg3);color:var(--dim);transition:all .15s}
.btn-ext:hover{color:var(--text);border-color:var(--sep3)}
.btn-drive{background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.22);color:var(--green);padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;transition:all .15s}
.btn-drive:hover{background:rgba(74,222,128,.15)}
.btn-drive:disabled{opacity:.5;cursor:default}

/* ── TOAST ───────────────────────────────────────────────────────────────── */
.toast{position:fixed;bottom:22px;right:22px;background:var(--bg2);border:1px solid var(--sep2);border-radius:8px;padding:10px 15px;font-size:12px;color:var(--text);z-index:300;transform:translateY(14px);opacity:0;transition:all .2s;pointer-events:none;max-width:300px}
.toast.on{transform:translateY(0);opacity:1}
.toast.ok{border-color:rgba(74,222,128,.3);color:var(--green)}
.toast.err{border-color:rgba(248,113,113,.3);color:var(--red)}

/* ── COMPAT ──────────────────────────────────────────────────────────────── */
.src-icon.reddit{color:var(--orange)}.src-icon.x{color:var(--dim)}.src-icon.rss{color:var(--green)}
.tag{display:inline-block;padding:2px 6px;border-radius:7px;font-size:10px;font-weight:500;background:var(--bg3);color:var(--dim2);border:1px solid var(--sep)}
.tag.hot{background:rgba(248,113,113,.07);color:var(--red);border-color:rgba(248,113,113,.18)}
.tag.trend{background:rgba(251,191,36,.07);color:var(--yellow);border-color:rgba(251,191,36,.18)}
.tag.brk{background:rgba(96,165,250,.07);color:var(--blue);border-color:rgba(96,165,250,.18)}
.news-card{background:var(--bg2);border:1px solid var(--sep);border-left:3px solid var(--sep2);border-radius:7px;padding:12px;cursor:pointer}
.news-card.hot{border-left-color:var(--red)}.news-card.rising{border-left-color:var(--yellow)}.news-card.notable{border-left-color:var(--blue)}

/* ── MOBILE ──────────────────────────────────────────────────────────────── */
@media(max-width:900px){
  .main-layout{flex-direction:column}
  .col-side{width:100%;position:static;max-height:none}
  .grid-section{grid-template-columns:repeat(2,1fr)}
  .hero-thumb{width:80px}
}
@media(max-width:520px){
  .grid-section{grid-template-columns:1fr}
  .hero-thumb{display:none}
  .stats{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="page">
<div class="header">
  <div>
    <h1 id="h-title">Radar Global<span class="h-badge global" id="h-badge">GLOBAL</span></h1>
    <div class="header-sub" id="h-sub">Ultimas 24h · X + Reddit · <span id="last-update">--</span></div>
  </div>
  <div class="header-right">
    <div class="status-pill"><div class="sdot"></div>LIVE</div>
    <div class="clock" id="clock">--:-- BRT</div>
  </div>
</div>
<div class="tabs">
  <div class="tab active" id="tab-global" onclick="switchTab('global')">Global <span class="tab-count" id="tc-global">0</span></div>
  <div class="tab" id="tab-brasil" onclick="switchTab('brasil')">Brasil <span class="tab-count" id="tc-brasil">0</span></div>
  <div class="tab" id="tab-tech" onclick="switchTab('tech')">Tech / AI <span class="tab-count" id="tc-tech">0</span></div>
  <div class="tab" id="tab-crypto" onclick="switchTab('crypto')">Cripto <span class="tab-count" id="tc-crypto">0</span></div>
</div>
<div class="main-layout">
  <div class="col-main">
    <div class="stats">
      <div class="stat"><div class="stat-val" style="color:var(--red)" id="s-hot">--</div><div class="stat-lbl">Trending</div></div>
      <div class="stat"><div class="stat-val" style="color:var(--green)" id="s-marco">--</div><div class="stat-lbl">Relevante p/vc</div></div>
      <div class="stat"><div class="stat-val" style="color:var(--orange)" id="s-reddit">--</div><div class="stat-lbl">Reddit</div></div>
      <div class="stat"><div class="stat-val" style="color:var(--text)" id="s-total">--</div><div class="stat-lbl">Total</div></div>
    </div>
    <div class="toolbar">
      <button class="btn primary" id="btn-refresh" onclick="loadTab(true)">Atualizar</button>
      <div class="sort-btns">
        <div class="sort-btn active" id="sort-smart" onclick="setSort('smart')">Smart</div>
        <div class="sort-btn" id="sort-hot" onclick="setSort('hot')">Hot</div>
        <div class="sort-btn" id="sort-new" onclick="setSort('new')">Recente</div>
      </div>
      <button class="btn" id="btn-brief" onclick="gerarBrief()">Gerar Brief</button>
      <button class="btn" id="btn-weights" onclick="openWeights()">Pesos</button>
      <div class="toolbar-r">
        <span id="read-count"></span>
        <div class="search">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" placeholder="Filtrar..." oninput="filterNews(this.value)" id="search-input">
        </div>
      </div>
    </div>
    <div class="src-row" id="src-row"></div>
    <div class="error-banner" id="error-banner">! <span id="error-msg">Algumas fontes indisponiveis</span></div>
    <div id="feed-root"><div class="feed-loading"><span class="spin">·</span> Buscando...</div></div>
    <div style="font-size:10px;color:var(--dim2);margin-top:8px;text-align:right" id="feed-count"></div>
  </div>
  <div class="col-side">
    <div class="side-section">
      <div class="side-title">TOP 10 — Score Marco</div>
      <div id="top10-list"></div>
    </div>
    <div class="side-section">
      <div class="side-title">Topicos</div>
      <div class="heat-row" id="heat-row"></div>
    </div>
  </div>
</div>
</div>
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-head">
    <div style="flex:1">
      <div class="drawer-title" id="dr-title">--</div>
      <div class="drawer-sub" id="dr-sub">--</div>
    </div>
    <button class="drawer-close" onclick="closeDrawer()">x</button>
  </div>
  <div class="drawer-body" id="dr-body"></div>
  <div class="drawer-foot">
    <a class="btn-ext" id="dr-link" href="#" target="_blank" rel="noopener">-> Ver original</a>
    <button class="btn-drive" id="btn-drive" onclick="saveToDrive()">+ Drive</button>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>var PROXY='https://notion-proxy.marcoaquilino.workers.dev';
var tabs={
  global:{label:'Global',badge:'GLOBAL',badgeClass:'global',loaded:false,items:[],sources:[],srcLabels:{}},
  brasil:{label:'Brasil',badge:'BR',badgeClass:'br',loaded:false,items:[],sources:[],srcLabels:{}},
  tech:  {label:'Tech/AI',badge:'TECH',badgeClass:'tech',loaded:false,items:[],sources:[],srcLabels:{}},
  crypto:{label:'Cripto',badge:'CRIPTO',badgeClass:'crypto',loaded:false,items:[],sources:[],srcLabels:{}},
};
var activeTab='global';
var activeFilter={src:'all',topic:null,query:''};
var activeSort='smart';
var currentDrawerItem=null;
var frankCache={};
var lastLoad={};


// ─── FEATURE 2: BADGE DE NOVOS NAS TABS ──────────────────────────────────────
var tabNewCounts={global:0,brasil:0,tech:0,crypto:0};
function markTabNew(tab, count){
  tabNewCounts[tab]=count;
  var el=document.getElementById('tc-'+tab);
  if(!el)return;
  if(count>0){
    el.textContent=tabs[tab].items.length+' +'+count;
    el.style.background='rgba(74,222,128,.2)';el.style.color='var(--green)';
  }else{
    el.textContent=tabs[tab].items.length;
    el.style.background='';el.style.color='';
  }
}

// ─── FEATURE 1: TAB CACHE (localStorage, TTL 15min) ──────────────────────────
var CACHE_TTL = 15 * 60 * 1000; // 15min
function saveTabCache(tab, items){
  try{
    localStorage.setItem('radar_cache_'+tab, JSON.stringify({ts:Date.now(), items:items}));
  }catch(e){}
}
function loadTabCache(tab){
  try{
    var raw=localStorage.getItem('radar_cache_'+tab);
    if(!raw)return null;
    var p=JSON.parse(raw);
    if(Date.now()-p.ts>CACHE_TTL)return null;
    return p.items;
  }catch(e){return null}
}
function clearTabCache(tab){
  try{localStorage.removeItem('radar_cache_'+tab)}catch(e){}
}

function pad(n){return String(n).padStart(2,'0')}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function fmtScore(n){return n>=1000?(n/1000).toFixed(1)+'k':String(n)}
function formatAge(utc){
  var diff=Math.floor(Date.now()/1000-utc);
  if(diff<60)return 'agora';
  if(diff<3600)return Math.floor(diff/60)+'min';
  if(diff<86400)return Math.floor(diff/3600)+'h';
  return Math.floor(diff/86400)+'d';
}
function parsePubDate(s){try{return new Date(s).getTime()/1000}catch(e){return 0}}
function getBRT(){return new Date(new Date().toLocaleString('en-US',{timeZone:'America/Sao_Paulo'}))}
function updateClock(){var d=getBRT();document.getElementById('clock').textContent=pad(d.getHours())+':'+pad(d.getMinutes())+' BRT'}
setInterval(updateClock,30000);updateClock();
// ─── DETECT HEAT / TOPIC ─────────────────────────────────────────────────────
function detectHeat(t){
  var tl=t.toLowerCase();
  if(/breaking|crisis|coup|\bwar\b|attack|invaded|bombed|impeach|emergency|urgent/.test(tl))return 'hot';
  if(/election|protest|sanctions|summit|deal|agreement|major|record|crash|surge|collapse/.test(tl))return 'rising';
  return 'notable';
}

var TOPICS_GLOBAL=[
  ['EUA',/trump|biden|harris|\busa\b|\bamerica\b|washington|congress|senate|pentagon|white house|republican|democrat/i],
  ['Brasil',/lula|brazil|brasil|bolsonaro|petrobras|stf|camara|senado/i],
  ['Europa',/europe\b|nato\b|germany|france|\buk\b|britain|spain|italy|macron|scholz|brussels|\beu\b/i],
  ['Russia/UA',/russia|ukraine|putin|zelensky|kiev|kyiv|kremlin|donbas|crimea/i],
  ['China',/china|xi jinping|beijing|taiwan|hong kong|huawei|\bccp\b/i],
  ['Medio Oriente',/israel|gaza|\biran\b|palestine|hamas|hezbollah|netanyahu|beirut|tehran/i],
  ['America Latina',/venezuela|argentina|chile|colombia|mexico\b|\bperu\b|maduro|milei|boric|petro/i],
  ['ONU/Diplomacia',/united nations|\bun\b|diplomat|ceasefire|treaty|\bg7\b|\bg20\b|\bimf\b/i],
];
var TOPICS_BR=[
  ['Politica',/lula|governo|camara|senado|bolsonaro|eleicao|ministro|presidente|stf|congresso/i],
  ['Economia',/inflacao|juros|selic|pib|real|dolar|economia|mercado|bolsa|ipca|deficit/i],
  ['Seguranca',/crime|policia|violencia|trafic|assassin|preso|operacao|milicia|morte/i],
  ['Saude',/sus|saude|hospital|doenca|vacina|covid|dengue|medico/i],
  ['Tecnologia',/tecnologia|startup|\bia\b|inteligencia artificial|app|internet|5g|anatel/i],
  ['Sociedade',/educacao|cultura|esporte|futebol|copa|olimpiada|arte|celebridade/i],
];
var TOPICS_TECH=[
  ['AI/LLM',/openai|anthropic|gemini|claude|gpt|llm|large language|artificial intelligence|machine learning|\bai\b/i],
  ['Startups',/startup|funding|series|venture|unicorn|ipo|acquisition|merger|valuation/i],
  ['Big Tech',/google|microsoft|apple|meta|amazon|nvidia|tesla|elon musk|sam altman|zuckerberg/i],
  ['Regulacao',/regulation|antitrust|gdpr|privacy|ban|law|congress|eu regulation|fcc/i],
  ['Open Source',/open.?source|github|linux|hugging.?face|ollama|mistral|llama/i],
  ['Produto',/launch|release|update|feature|product|app|tool|platform|api/i],
];
var TOPICS_CRYPTO=[
  ['Bitcoin',/bitcoin|\bbtc\b/i],
  ['Ethereum',/ethereum|\beth\b|defi|erc.20/i],
  ['Altcoins',/solana|cardano|avalanche|polygon|xrp|ripple|dogecoin|\bsol\b|\bada\b/i],
  ['Mercado',/price|rally|crash|dip|bull|bear|market|exchange|binance|coinbase|volume|liquidation/i],
  ['Regulacao',/regulation|sec|cftc|ban|legal|law|etf|approval|government/i],
  ['DeFi/NFT',/defi|nft|dao|staking|yield|protocol|blockchain|web3/i],
];

function getTopics(tab){
  if(tab==='brasil')return TOPICS_BR;
  if(tab==='tech')return TOPICS_TECH;
  if(tab==='crypto')return TOPICS_CRYPTO;
  return TOPICS_GLOBAL;
}
function detectTopic(text,tab){
  var topics=getTopics(tab);
  for(var i=0;i<topics.length;i++){if(topics[i][1].test(text))return topics[i][0]}
  return 'Outros';
}
function detectTags(t,heat){
  var r=[],tl=t.toLowerCase();
  if(heat==='hot')r.push({l:'Breaking',c:'hot'});
  if(/election|eleicao|vote/.test(tl))r.push({l:'Eleicao',c:'brk'});
  if(/\bwar\b|guerra|attack|conflict/.test(tl))r.push({l:'Conflito',c:'hot'});
  if(/economy|inflation|gdp|market|economia|mercado/.test(tl))r.push({l:'Economia',c:'trend'});
  if(/sanction|tariff|trade|acordo|diplomacia/.test(tl))r.push({l:'Diplomacia',c:'brk'});
  if(/ai\b|artificial|openai|anthropic|llm/.test(tl))r.push({l:'AI',c:'brk'});
  if(/bitcoin|crypto|btc|eth\b/.test(tl))r.push({l:'Cripto',c:'trend'});
  return r.slice(0,3);
}

// marcoScore: ver Feature 5 (com pesos editaveis)
// ─── FETCH FUNCTIONS ─────────────────────────────────────────────────────────
async function fetchReddit(sub,tab){
  var r=await fetch(PROXY+'/reddit?sub='+sub+'&limit=20');
  if(!r.ok)throw new Error('Reddit/'+sub+' '+r.status);
  var data=await r.json();
  return(data.data&&data.data.children||[]).filter(function(p){return !p.data.stickied&&p.data.score>10}).map(function(p){
    var d=p.data,heat=detectHeat(d.title),text=d.title+' '+(d.selftext||'');
    return{id:'r_'+d.id,src:'reddit',srcType:'reddit',label:'r/'+d.subreddit,thumb:d.thumbnail||'',
      title:d.title,preview:(d.selftext||'').slice(0,280),url:'https://reddit.com'+d.permalink,
      score:d.score,comments_count:d.num_comments,age:formatAge(d.created_utc),ageTs:d.created_utc,
      heat:heat,topic:detectTopic(text,tab),tags:detectTags(d.title,heat),marcoScore:0};
  });
}

async function fetchBrave(query,tab){
  var r=await fetch(PROXY+'/brave?q='+encodeURIComponent(query)+'&count=15&freshness=pd');
  if(!r.ok)throw new Error('Brave '+r.status);
  var data=await r.json();
  return((data.web&&data.web.results)||[]).map(function(w){
    var isR=!!(w.url&&w.url.includes('reddit.com'));
    var sm=w.url&&w.url.match(/reddit\.com\/r\/([^\/]+)/);
    var heat=detectHeat(w.title+' '+(w.description||''));
    var host='';try{host=new URL(w.url||'https://news.com').hostname.replace('www.','')}catch(e){}
    var text=w.title+' '+(w.description||'');
    return{id:'b_'+(w.url||'x').replace(/[^a-z0-9]/gi,'').slice(-10),
      src:isR?'reddit':'x',srcType:isR?'reddit':'x',label:isR?(sm?'r/'+sm[1]:'Reddit'):host,
      title:w.title,preview:w.description||'',url:w.url||'#',
      score:0,comments_count:0,age:'Hoje',ageTs:Date.now()/1000-3600,
      heat:heat,topic:detectTopic(text,tab),tags:detectTags(w.title,heat),marcoScore:0};
  });
}

async function fetchRSS(src,tab){
  var r=await fetch(PROXY+'/rss?src='+src);
  if(!r.ok)throw new Error('RSS/'+src+' '+r.status);
  var data=await r.json();
  return(data.items||[]).map(function(item){
    var heat=detectHeat(item.title);
    var text=item.title+' '+(item.description||'');
    var ts=parsePubDate(item.pubDate);
    return{id:'rss_'+src+'_'+btoa(item.link||item.title).slice(0,8).replace(/[^a-z0-9]/gi,''),
      src:'rss',srcType:'rss',label:src.toUpperCase(),
      title:item.title,preview:item.description||'',url:item.link||'#',
      score:0,comments_count:0,age:ts?formatAge(ts):'Hoje',ageTs:ts||Date.now()/1000-7200,
      heat:heat,topic:detectTopic(text,tab),tags:detectTags(item.title,heat),marcoScore:0};
  });
}

// ─── TAB FETCH CONFIGS ────────────────────────────────────────────────────────
var TAB_FETCHES={
  global:[
    function(){return fetchReddit('worldnews','global')},
    function(){return fetchReddit('politics','global')},
    function(){return fetchReddit('geopolitics','global')},
    function(){return fetchBrave('world politics government election breaking news 2026','global')},
    function(){return fetchBrave('geopolitics international diplomacy sanctions war 2026','global')},
  ],
  brasil:[
    function(){return fetchReddit('brazil','brasil')},
    function(){return fetchReddit('brasil','brasil')},
    function(){return fetchReddit('investimentos','brasil')},
    function(){return fetchRSS('g1','brasil')},
    function(){return fetchRSS('uol','brasil')},
    function(){return fetchBrave('brasil noticias politica economia hoje 2026','brasil')},
  ],
  tech:[
    function(){return fetchReddit('technology','tech')},
    function(){return fetchReddit('artificial','tech')},
    function(){return fetchReddit('MachineLearning','tech')},
    function(){return fetchReddit('LocalLLaMA','tech')},
    function(){return fetchBrave('artificial intelligence openai anthropic google tech news 2026','tech')},
    function(){return fetchBrave('AI startup funding tech regulation 2026','tech')},
  ],
  crypto:[
    function(){return fetchReddit('CryptoCurrency','crypto')},
    function(){return fetchReddit('Bitcoin','crypto')},
    function(){return fetchReddit('ethereum','crypto')},
    function(){return fetchBrave('bitcoin ethereum crypto market price regulation 2026','crypto')},
    function(){return fetchBrave('DeFi blockchain web3 news 2026','crypto')},
  ],
};

// ─── TOPIC COLORS ────────────────────────────────────────────────────────────
var TOPIC_COLORS={
  // Global
  'EUA':         {bg:'rgba(248,113,113,.12)',c:'#f87171',b:'rgba(248,113,113,.25)'},
  'Brasil':      {bg:'rgba(74,222,128,.12)',c:'#4ade80',b:'rgba(74,222,128,.25)'},
  'Europa':      {bg:'rgba(96,165,250,.12)',c:'#60a5fa',b:'rgba(96,165,250,.25)'},
  'Russia/UA':   {bg:'rgba(251,146,60,.12)',c:'#fb923c',b:'rgba(251,146,60,.25)'},
  'China':       {bg:'rgba(252,211,77,.12)',c:'#fcd34d',b:'rgba(252,211,77,.25)'},
  'Medio Oriente':{bg:'rgba(192,132,252,.12)',c:'#c084fc',b:'rgba(192,132,252,.25)'},
  'America Latina':{bg:'rgba(251,191,36,.1)',c:'#fbbf24',b:'rgba(251,191,36,.22)'},
  'ONU/Diplomacia':{bg:'rgba(255,255,255,.04)',c:'#888',b:'rgba(255,255,255,.1)'},
  // Brasil
  'Politica':    {bg:'rgba(248,113,113,.1)',c:'#f87171',b:'rgba(248,113,113,.22)'},
  'Economia':    {bg:'rgba(74,222,128,.1)',c:'#4ade80',b:'rgba(74,222,128,.22)'},
  'Seguranca':   {bg:'rgba(251,146,60,.1)',c:'#fb923c',b:'rgba(251,146,60,.22)'},
  'Saude':       {bg:'rgba(96,165,250,.1)',c:'#60a5fa',b:'rgba(96,165,250,.22)'},
  'Tecnologia':  {bg:'rgba(192,132,252,.1)',c:'#c084fc',b:'rgba(192,132,252,.22)'},
  'Sociedade':   {bg:'rgba(251,191,36,.1)',c:'#fbbf24',b:'rgba(251,191,36,.22)'},
  // Tech
  'AI/LLM':      {bg:'rgba(96,165,250,.12)',c:'#60a5fa',b:'rgba(96,165,250,.25)'},
  'Startups':    {bg:'rgba(74,222,128,.12)',c:'#4ade80',b:'rgba(74,222,128,.25)'},
  'Big Tech':    {bg:'rgba(192,132,252,.12)',c:'#c084fc',b:'rgba(192,132,252,.25)'},
  'Regulacao':   {bg:'rgba(248,113,113,.1)',c:'#f87171',b:'rgba(248,113,113,.22)'},
  'Open Source': {bg:'rgba(251,146,60,.1)',c:'#fb923c',b:'rgba(251,146,60,.22)'},
  'Produto':     {bg:'rgba(252,211,77,.1)',c:'#fcd34d',b:'rgba(252,211,77,.22)'},
  // Crypto
  'Bitcoin':     {bg:'rgba(252,211,77,.14)',c:'#fcd34d',b:'rgba(252,211,77,.28)'},
  'Ethereum':    {bg:'rgba(96,165,250,.12)',c:'#60a5fa',b:'rgba(96,165,250,.25)'},
  'Altcoins':    {bg:'rgba(192,132,252,.1)',c:'#c084fc',b:'rgba(192,132,252,.22)'},
  'Mercado':     {bg:'rgba(74,222,128,.1)',c:'#4ade80',b:'rgba(74,222,128,.22)'},
  'DeFi/NFT':    {bg:'rgba(251,146,60,.1)',c:'#fb923c',b:'rgba(251,146,60,.22)'},
  // Fallback
  'Outros':      {bg:'rgba(255,255,255,.04)',c:'#555',b:'rgba(255,255,255,.06)'},
};
function topicColor(t){return TOPIC_COLORS[t]||TOPIC_COLORS['Outros']}

// FRANK'S TAKE CACHE (localStorage + in-memory)
function getFrankTake(id){
  try{var k='frank_'+id;var v=localStorage.getItem(k);if(v){var p=JSON.parse(v);if(Date.now()-p.ts<86400000)return p.take}}catch(e){}
  return null;
}
function setFrankTake(id,take){
  try{localStorage.setItem('frank_'+id,JSON.stringify({take:take,ts:Date.now()}))}catch(e){}
}
// ─── LOAD + PROCESS ──────────────────────────────────────────────────────────
async function loadTab(force){
  var tab=activeTab;
  if(tabs[tab].loaded&&!force)return;

  var btn=document.getElementById('btn-refresh');
  btn.disabled=true;btn.textContent='Buscando...';
  document.getElementById('error-banner').classList.remove('on');
  document.getElementById('top10-list').innerHTML='';
  activeFilter.topic=null;
  document.querySelector('#search-input').value='';
  activeFilter.query='';

  // FEATURE 1: tenta cache primeiro (só se não for force)
  if(!force){
    var cached=loadTabCache(tab);
    if(cached&&cached.length>0){
      tabs[tab].items=cached;
      tabs[tab].loaded=true;
      lastLoad[tab]=Date.now()-CACHE_TTL+1; // marca como carregado do cache
      var srcMap={};
      cached.forEach(function(x){srcMap[x.srcType]=(srcMap[x.srcType]||0)+1});
      tabs[tab].srcLabels=srcMap;
      document.getElementById('tc-'+tab).textContent=cached.length;
      updateStats();buildSrcFilters();buildHeatMap();renderAll();
      btn.disabled=false;btn.textContent='Atualizar';
      document.getElementById('last-update').textContent='Cache';
      return;
    }
  }

  document.getElementById('feed-root').innerHTML='<div class="feed-loading"><span class="spin">·</span> Buscando...</div>';

  var fetches=TAB_FETCHES[tab];
  var res=await Promise.allSettled(fetches.map(function(f){return f()}));
  var items=[],err=false;
  for(var i=0;i<res.length;i++){
    if(res[i].status==='fulfilled')items=items.concat(res[i].value);
    else{err=true;console.warn('fetch:',res[i].reason&&res[i].reason.message)}
  }
  if(err)document.getElementById('error-banner').classList.add('on');

  // Dedup by URL
  var seen={};
  items=items.filter(function(x){if(seen[x.url])return false;seen[x.url]=1;return true});

  // Compute marco score
  items.forEach(function(x){x.marcoScore=marcoScore(x)});

  // FEATURE 2: detecta itens novos vs cache anterior
  var prevCache=loadTabCache(tab)||[];
  var prevUrls={};prevCache.forEach(function(x){prevUrls[x.url]=1});
  var newCount=items.filter(function(x){return !prevUrls[x.url]}).length;
  items.forEach(function(x){x.isNew=!prevUrls[x.url]});

  // FEATURE 1: salva cache
  saveTabCache(tab, items);

  tabs[tab].items=items;
  tabs[tab].loaded=true;
  lastLoad[tab]=Date.now();

  // FEATURE 2: mostra badge de novos
  if(newCount>0 && force){
    showToast(newCount+' novo'+(newCount>1?'s':'')+' em '+tab,'ok');
  }

  var srcMap={};
  items.forEach(function(x){srcMap[x.srcType]=(srcMap[x.srcType]||0)+1});
  tabs[tab].srcLabels=srcMap;
  tabs[tab].sources=Object.keys(srcMap);

  document.getElementById('tc-'+tab).textContent=items.length;
  updateStats();
  buildSrcFilters();
  buildHeatMap();
  renderAll();

  btn.disabled=false;btn.textContent='Atualizar';
  document.getElementById('last-update').textContent='Agora';
}

// ─── SORT + FILTER ───────────────────────────────────────────────────────────
function getFiltered(){
  var items=tabs[activeTab].items.slice();
  if(activeFilter.src!=='all')items=items.filter(function(n){return n.srcType===activeFilter.src});
  if(activeFilter.topic)items=items.filter(function(n){return n.topic===activeFilter.topic});
  if(activeFilter.query){
    var q=activeFilter.query.toLowerCase();
    items=items.filter(function(n){return n.title.toLowerCase().indexOf(q)>-1||n.preview.toLowerCase().indexOf(q)>-1});
  }
  return items;
}

function getSorted(items){
  var sorted=items.slice();
  if(activeSort==='smart'){
    sorted.sort(function(a,b){
      var heatO={hot:0,rising:1,notable:2};
      var heatDiff=heatO[a.heat]-heatO[b.heat];
      if(heatDiff!==0)return heatDiff;
      return (b.marcoScore+b.score/500)-(a.marcoScore+a.score/500);
    });
  }else if(activeSort==='hot'){
    sorted.sort(function(a,b){
      var heatO={hot:0,rising:1,notable:2};
      return (heatO[a.heat]-heatO[b.heat])||b.score-a.score;
    });
  }else{
    sorted.sort(function(a,b){return b.ageTs-a.ageTs});
  }
  return sorted;
}

// ─── STATS ───────────────────────────────────────────────────────────────────
function updateStats(){
  var items=tabs[activeTab].items;
  document.getElementById('s-hot').textContent=items.filter(function(n){return n.heat==='hot'}).length;
  document.getElementById('s-marco').textContent=items.filter(function(n){return n.marcoScore>=40}).length;
  document.getElementById('s-reddit').textContent=items.filter(function(n){return n.srcType==='reddit'}).length;
  document.getElementById('s-total').textContent=items.length;
}

// ─── SRC FILTERS ─────────────────────────────────────────────────────────────
var SRC_LABELS={reddit:'Reddit',x:'X / News',rss:'RSS / Jornais'};
var SRC_COLORS={reddit:'#fb923c',x:'#888',rss:'#4ade80'};

function buildSrcFilters(){
  var row=document.getElementById('src-row');row.innerHTML='';
  var allEl=document.createElement('div');
  allEl.className='sf on';allEl.id='sf-all';
  allEl.innerHTML='<div class="src-dot" style="background:var(--green)"></div>Todos';
  allEl.onclick=function(){setSrc('all')};
  row.appendChild(allEl);
  var srcMap=tabs[activeTab].srcLabels;
  Object.keys(srcMap).forEach(function(s){
    var el=document.createElement('div');
    el.className='sf';el.id='sf-'+s;
    var dot='<div class="src-dot" style="background:'+(SRC_COLORS[s]||'#888')+'"></div>';
    el.innerHTML=dot+(SRC_LABELS[s]||s)+' <span style="color:var(--dim2)">('+srcMap[s]+')</span>';
    (function(src){el.onclick=function(){setSrc(src)}})(s);
    row.appendChild(el);
  });
}

// ─── HEAT MAP ────────────────────────────────────────────────────────────────
function buildHeatMap(){
  var items=getFiltered();
  var counts={};items.forEach(function(n){counts[n.topic]=(counts[n.topic]||0)+1});
  var sorted=Object.keys(counts).map(function(k){return[k,counts[k]]}).sort(function(a,b){return b[1]-a[1]});
  var row=document.getElementById('heat-row');row.innerHTML='';
  sorted.forEach(function(pair){
    var t=pair[0],c=pair[1],s=topicColor(t);
    var el=document.createElement('div');
    el.className='heat-tag'+(activeFilter.topic===t?' active':'');
    el.style.background=s.bg;el.style.color=s.c;el.style.borderColor=s.b;
    el.textContent=t+' ('+c+')';
    (function(topic){el.onclick=function(){setTopic(topic)}})(t);
    row.appendChild(el);
  });
}

// ─── TOP 10 ───────────────────────────────────────────────────────────────────
function renderTop10(){
  var items=tabs[activeTab].items.slice();
  items.sort(function(a,b){return b.marcoScore-a.marcoScore});
  var top=items.slice(0,10);
  var list=document.getElementById('top10-list');list.innerHTML='';
  top.forEach(function(item,i){
    var rank=i+1;
    var rankClass=rank===1?'r1':rank===2?'r2':rank===3?'r3':'';
    var ms=item.marcoScore;
    var msClass=ms>=50?'hi':ms>=25?'mid':'lo';
    var msLabel=ms>=50?'&#9733; '+ms:ms>=25?ms:'';
    var el=document.createElement('div');el.className='top10-item'+(isRead(item.id)?' is-read':'');
    el.innerHTML=
      '<div class="top10-rank '+rankClass+'">'+(rank<=3?['1.','2.','3.'][rank-1]:rank)+'</div>'+
      '<div style="flex:1;min-width:0">'+
      '<div class="top10-title">'+esc(item.title)+'</div>'+
      '<div class="top10-meta">'+
      '<span class="top10-score" style="color:'+(item.srcType==='reddit'?'var(--orange)':'var(--dim2)')+'">'+esc(item.label)+'</span>'+
      (item.score>0?'<span class="top10-score">&#8593;'+fmtScore(item.score)+'</span>':'')+
      '<span class="top10-score">'+item.age+'</span>'+
      (ms>0?'<span class="marco-score '+msClass+'">'+msLabel+'</span>':'')+
      '</div></div>';
    (function(id){el.onclick=function(){openDrawer(id)}})(item.id);
    list.appendChild(el);
  });
}

// ─── FEED ─────────────────────────────────────────────────────────────────────
function renderFeed(){
  var items=getSorted(getFiltered());
  var root=document.getElementById('feed-root');
  document.getElementById('feed-count').textContent=items.length+' itens';
  if(!items.length){root.innerHTML='<div class="feed-empty"><p>Nenhum resultado</p><small>Tente outro filtro ou Atualizar</small></div>';return}
  var feed=document.createElement('div');feed.className='feed';
  items.forEach(function(item){
    var ms=item.marcoScore;
    var msClass=ms>=50?'hi':ms>=25?'mid':'lo';
    var scoreHtml=item.score>0?'<span style="color:'+(item.score>10000?'var(--green)':item.score>3000?'var(--yellow)':'var(--dim2)')+'">&#8593;'+fmtScore(item.score)+'</span>':'';
    var tagsHtml=item.tags.map(function(t){return'<span class="tag '+t.c+'">'+esc(t.l)+'</span>'}).join('');
    var card=document.createElement('div');card.className='news-card '+item.heat+(isRead(item.id)?' is-read':'');
    card.innerHTML=
      '<div class="card-head">'+
      '<div class="src-icon '+item.srcType+'">'+(item.srcType==='reddit'?'R':item.srcType==='rss'?'RSS':'X')+'</div>'+
      '<div class="card-title">'+esc(item.title)+'</div>'+
      '</div>'+
      '<div class="card-meta">'+
      '<span style="color:var(--dim2)">'+esc(item.label)+'</span>'+
      scoreHtml+
      '<span style="color:var(--dim2)">'+item.age+'</span>'+
      (ms>=25?'<span class="marco-score '+msClass+' card-marco-score">&#9733; '+ms+'</span>':'')+
      '</div>'+
      (item.preview?'<div class="card-preview">'+esc(item.preview)+'</div>':'')+
      (tagsHtml?'<div class="card-footer">'+tagsHtml+'</div>':'');
    (function(id){card.onclick=function(){openDrawer(id)}})(item.id);
    feed.appendChild(card);
  });
  root.innerHTML='';root.appendChild(feed);
}

function renderAll(){buildHeatMap();renderTop10();renderFeed()}

// ─── DRAWER ───────────────────────────────────────────────────────────────────
function findItem(id){
  var items=tabs[activeTab].items;
  for(var i=0;i<items.length;i++){if(items[i].id===id)return items[i]}
  return null;
}

function openDrawer(id){
  var item=findItem(id);if(!item)return;
  currentDrawerItem=item;
  markRead(id);updateReadBadge();
  document.getElementById('dr-title').textContent=item.title;
  var ms=item.marcoScore;
  var msStr=ms>=50?'&#9733; '+ms+' Marco':ms>=25?ms+' Marco':'';
  document.getElementById('dr-sub').innerHTML=
    '<span style="color:'+(item.srcType==='reddit'?'var(--orange)':item.srcType==='rss'?'var(--green)':'var(--dim)')+'">'+esc(item.label)+'</span>'+
    (item.score>0?'<span>&#8593;'+fmtScore(item.score)+'</span>':'')+
    '<span style="color:var(--dim2)">'+item.age+'</span>'+
    (ms>=25?'<span class="marco-score '+(ms>=50?'hi':'mid')+'">'+msStr+'</span>':'');
  document.getElementById('dr-link').href=item.url;

  // Render body
  var cached=getFrankTake(id);
  document.getElementById('dr-body').innerHTML=
    '<div class="dr-s">'+
    '<div class="dr-label">Conteudo</div>'+
    '<div class="dr-text">'+esc(item.preview||'Ver original para conteudo completo.')+'</div>'+
    '</div>'+
    '<div class="dr-s">'+
    '<div class="dr-label">Frank\'s Take</div>'+
    '<div class="dr-frank'+(cached?'':' loading')+'" id="dr-frank">'+(cached?esc(cached):'Analisando...')+'</div>'+
    '</div>'+
    '<div class="dr-s">'+
    '<div class="dr-label">Contexto</div>'+
    '<div class="dr-meta-grid">'+
    '<div class="dr-meta-item"><span>Topico</span><span>'+esc(item.topic)+'</span></div>'+
    '<div class="dr-meta-item"><span>Fonte</span><span>'+esc(item.label)+'</span></div>'+
    '<div class="dr-meta-item"><span>Relevancia</span><span>'+(item.heat==='hot'?'Trending':item.heat==='rising'?'Rising':'Notable')+'</span></div>'+
    '<div class="dr-meta-item"><span>Score Marco</span><span>'+item.marcoScore+'/100</span></div>'+
    '</div></div>';

  document.getElementById('drawer-overlay').classList.add('on');
  document.getElementById('drawer').classList.add('on');

  if(!cached){
    loadFrankTake(item);
  }
}

async function loadFrankTake(item){
  try{
    var r=await fetch(PROXY+'/frank-take',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({title:item.title,preview:item.preview||''})
    });
    var data=await r.json();
    var take=data.take||'';
    if(take){
      setFrankTake(item.id,take);
      var el=document.getElementById('dr-frank');
      if(el){el.className='dr-frank';el.textContent=take}
    }
  }catch(e){
    var el=document.getElementById('dr-frank');
    if(el){el.className='dr-frank';el.textContent='Analise indisponivel no momento.'}
  }
}

async function saveToDrive(){
  var item=currentDrawerItem;if(!item)return;
  var btn=document.getElementById('btn-drive');
  btn.disabled=true;btn.textContent='Salvando...';
  try{
    // FEATURE 3: chama CF Worker /save-drive que aciona pipeline drive-research
    var frankTake=getFrankTake(item.id)||'';
    var payload={
      title:item.title,
      url:item.url,
      preview:item.preview||'',
      frank_take:frankTake,
      topic:item.topic||'',
      source:item.label||'',
      tab:activeTab
    };
    var r=await fetch(PROXY+'/save-drive',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(r.ok){
      var data=await r.json();
      showToast('Salvo no Drive — '+item.title.slice(0,40),'ok');
      btn.textContent='Salvo';
      setTimeout(function(){btn.textContent='+ Drive';btn.disabled=false},2000);
    }else{
      throw new Error('status '+r.status);
    }
  }catch(e){
    // Fallback: abre Telegram
    var msg='drive-research: salvar\nTitulo: '+item.title+'\nURL: '+item.url+'\nFrank: '+getFrankTake(item.id);
    window.open('https://t.me/ImFrankBot?text='+encodeURIComponent(msg),'_blank');
    showToast('Abrindo Telegram como fallback','ok');
    btn.textContent='+ Drive';btn.disabled=false;
  }
}

function closeDrawer(){
  document.getElementById('drawer-overlay').classList.remove('on');
  document.getElementById('drawer').classList.remove('on');
  currentDrawerItem=null;
}
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeDrawer()});

// ─── TAB SWITCH ───────────────────────────────────────────────────────────────
var TAB_META={
  global:{title:'Radar Global',badge:'GLOBAL',badgeClass:'global',sub:'Ultimas 24h · X + Reddit'},
  brasil:{title:'Radar Brasil',badge:'BR',badgeClass:'br',sub:'Ultimas 24h · G1 + Reddit + UOL'},
  tech:  {title:'Radar Tech / AI',badge:'TECH',badgeClass:'tech',sub:'Ultimas 24h · Reddit + Brave'},
  crypto:{title:'Radar Cripto',badge:'CRIPTO',badgeClass:'crypto',sub:'Ultimas 24h · Reddit + Brave'},
};

function switchTab(t){
  if(t===activeTab&&tabs[t].loaded)return;
  activeTab=t;
  activeFilter={src:'all',topic:null,query:''};
  activeSort='smart';
  document.querySelectorAll('.tab').forEach(function(el){el.classList.remove('active')});
  document.getElementById('tab-'+t).classList.add('active');
  document.querySelectorAll('.sort-btn').forEach(function(el){el.classList.remove('active')});
  document.getElementById('sort-smart').classList.add('active');
  var meta=TAB_META[t];
  document.getElementById('h-title').innerHTML=meta.title+' <span class="h-badge '+meta.badgeClass+'" id="h-badge">'+meta.badge+'</span>'+meta.badgeClass+'" id="h-badge">'+meta.badge+'</span>';
  document.getElementById('h-sub').innerHTML=meta.sub+' &middot; <span id="last-update">'+(lastLoad[t]?'Agora':'&mdash;')+'</span>';
  loadTab();
}

// ─── FILTER CONTROLS ─────────────────────────────────────────────────────────
function setSrc(s){
  activeFilter.src=s;
  document.querySelectorAll('.sf').forEach(function(el){el.classList.remove('on')});
  var el=document.getElementById('sf-'+s);if(el)el.classList.add('on');
  renderAll();
}
function setTopic(t){
  activeFilter.topic=activeFilter.topic===t?null:t;
  renderAll();
}
function setSort(s){
  activeSort=s;
  document.querySelectorAll('.sort-btn').forEach(function(el){el.classList.remove('active')});
  document.getElementById('sort-'+s).classList.add('active');
  renderAll();
}
function filterNews(q){activeFilter.query=q;renderAll()}


// ─── FEATURE 4: GERAR BRIEF ──────────────────────────────────────────────────
async function gerarBrief(){
  var btn=document.getElementById('btn-brief');
  btn.disabled=true;btn.textContent='Gerando...';

  // Coleta TOP 5 de cada tab com dados carregados
  var sections=[];
  var tabKeys=['global','brasil','tech','crypto'];
  var tabNames={global:'Global',brasil:'Brasil',tech:'Tech / AI',crypto:'Cripto'};
  tabKeys.forEach(function(t){
    if(!tabs[t].items||!tabs[t].items.length)return;
    var top5=tabs[t].items.slice().sort(function(a,b){return b.marcoScore-a.marcoScore}).slice(0,5);
    sections.push('== '+tabNames[t]+' ==');
    top5.forEach(function(item,i){
      sections.push((i+1)+'. '+item.title+' [score:'+item.marcoScore+']');
    });
  });

  if(!sections.length){
    showToast('Carregue pelo menos uma tab antes de gerar o brief','err');
    btn.disabled=false;btn.textContent='Gerar Brief';
    return;
  }

  var prompt='Voce eh Frank, analista de negocios para um empreendedor brasileiro (SaaS, cripto, AI). '+
    'Gere um brief executivo de hoje em 10-12 linhas, organizado por tema, focando no que impacta '+
    'negocios digitais, cripto e o contexto brasileiro. Direto, sem intro, sem emojis, em PT-BR.\n\n'+
    'Noticias do momento:\n'+sections.join('\n');

  try{
    var r=await fetch(PROXY+'/frank-take',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({title:'BRIEF EXECUTIVO — '+new Date().toLocaleDateString('pt-BR'),preview:sections.join(' | ')})
    });
    var data=await r.json();
    var brief=data.take||'Falhou ao gerar brief.';

    // Mostra modal com o brief
    showBriefModal(brief);
    btn.disabled=false;btn.textContent='Gerar Brief';
  }catch(e){
    showToast('Erro ao gerar brief: '+e.message,'err');
    btn.disabled=false;btn.textContent='Gerar Brief';
  }
}

function showBriefModal(text){
  // Remove modal existente se houver
  var existing=document.getElementById('brief-modal');
  if(existing)existing.remove();

  var overlay=document.createElement('div');
  overlay.id='brief-modal';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

  var box=document.createElement('div');
  box.style.cssText='background:#1a1a1a;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:24px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto;position:relative';

  var date=new Date().toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  box.innerHTML=
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">'+
    '<div><div style="font-size:14px;font-weight:700;color:#e2e2e2">Brief Executivo</div>'+
    '<div style="font-size:11px;color:#888;margin-top:2px">'+date+'</div></div>'+
    '<button onclick="document.getElementById(\'brief-modal\').remove()" style="background:none;border:none;color:#888;cursor:pointer;font-size:16px;padding:4px">x</button>'+
    '</div>'+
    '<div style="font-size:13px;color:#e2e2e2;line-height:1.8;white-space:pre-wrap">'+escHtml(text)+'</div>'+
    '<div style="margin-top:16px;display:flex;gap:8px">'+
    '<button onclick="copyBrief()" style="padding:7px 14px;border-radius:5px;border:1px solid rgba(255,255,255,.1);background:#222;color:#888;font-size:11px;cursor:pointer">Copiar</button>'+
    '<button onclick="sendBriefTelegram()" style="padding:7px 14px;border-radius:5px;border:1px solid rgba(74,222,128,.25);background:rgba(74,222,128,.08);color:#4ade80;font-size:11px;cursor:pointer">Enviar Telegram</button>'+
    '</div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // Fecha com ESC
  var keyHandler=function(e){if(e.key==='Escape'){overlay.remove();document.removeEventListener('keydown',keyHandler)}};
  document.addEventListener('keydown',keyHandler);
}

function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

async function copyBrief(){
  var el=document.querySelector('#brief-modal div[style*="pre-wrap"]');
  if(!el)return;
  try{await navigator.clipboard.writeText(el.textContent);showToast('Copiado','ok')}
  catch(e){showToast('Erro ao copiar','err')}
}

function sendBriefTelegram(){
  var el=document.querySelector('#brief-modal div[style*="pre-wrap"]');
  if(!el)return;
  var text=el.textContent;
  window.open('https://t.me/ImFrankBot?text='+encodeURIComponent(text),'_blank');
}


// ─── FEATURE 5: SCORE MARCO EDITAVEL ─────────────────────────────────────────
var DEFAULT_WEIGHTS={ai:40,crypto:35,startup:25,brasil:20,geopolitics:15,hot:10,rising:5,score_hi:10,score_mid:5};
var scoreWeights=Object.assign({},DEFAULT_WEIGHTS);
(function(){
  try{var w=localStorage.getItem('radar_weights');if(w)scoreWeights=JSON.parse(w)}catch(e){}
})();

function marcoScore(item){
  var s=0,t=(item.title+' '+(item.preview||'')).toLowerCase();
  if(/openai|anthropic|claude|gpt|llm|\bai\b|artificial intelligence|nvidia|automation/.test(t))s+=scoreWeights.ai;
  if(/bitcoin|btc|ethereum|\beth\b|crypto|defi|web3|blockchain|solana|binance/.test(t))s+=scoreWeights.crypto;
  if(/startup|saas|funding|revenue|monetiz|growth|mrr|arr|valuation|venture/.test(t))s+=scoreWeights.startup;
  if(/brasil|brazil|lula|\breal\b|selic|brl|mercado livre|nubank/.test(t))s+=scoreWeights.brasil;
  if(/tariff|sanction|trade war|oil price|supply chain/.test(t))s+=scoreWeights.geopolitics;
  if(item.heat==='hot')s+=scoreWeights.hot;
  if(item.heat==='rising')s+=scoreWeights.rising;
  if(item.score>10000)s+=scoreWeights.score_hi;else if(item.score>3000)s+=scoreWeights.score_mid;
  return Math.min(100,s);
}

function openWeights(){
  var existing=document.getElementById('weights-modal');
  if(existing){existing.remove();return}

  var labels={ai:'AI / LLM',crypto:'Cripto',startup:'Startup / SaaS',brasil:'Brasil',geopolitics:'Geopolitica',hot:'Breaking (hot)',rising:'Rising',score_hi:'Reddit >10k',score_mid:'Reddit >3k'};

  var overlay=document.createElement('div');
  overlay.id='weights-modal';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px';
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

  var box=document.createElement('div');
  box.style.cssText='background:#1a1a1a;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:24px;max-width:480px;width:100%;position:relative';

  var title=document.createElement('div');
  title.style.cssText='font-size:14px;font-weight:700;margin-bottom:4px';
  title.textContent='Pesos do Score Marco';
  box.appendChild(title);

  var sub=document.createElement('div');
  sub.style.cssText='font-size:11px;color:#888;margin-bottom:16px';
  sub.textContent='Ajusta o que importa mais pro seu contexto agora';
  box.appendChild(sub);

  Object.keys(DEFAULT_WEIGHTS).forEach(function(k){
    var v=scoreWeights[k];
    var row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:10px;margin-bottom:10px';

    var lbl=document.createElement('div');
    lbl.style.cssText='width:140px;font-size:12px;color:#888';
    lbl.textContent=labels[k]||k;
    row.appendChild(lbl);

    var inp=document.createElement('input');
    inp.type='range';inp.id='w_'+k;inp.min='0';inp.max='60';inp.value=v;
    inp.style.cssText='flex:1;accent-color:#4ade80';
    (function(key){inp.oninput=function(){var el=document.getElementById('wv_'+key);if(el)el.textContent=this.value}})(k);
    row.appendChild(inp);

    var val=document.createElement('div');
    val.id='wv_'+k;val.style.cssText='width:24px;font-size:12px;color:#4ade80;text-align:right';
    val.textContent=v;
    row.appendChild(val);

    box.appendChild(row);
  });

  var footer=document.createElement('div');
  footer.style.cssText='display:flex;gap:8px;margin-top:16px';

  var btnApply=document.createElement('button');
  btnApply.style.cssText='flex:1;padding:8px;border-radius:5px;border:1px solid rgba(74,222,128,.25);background:rgba(74,222,128,.08);color:#4ade80;font-size:12px;cursor:pointer';
  btnApply.textContent='Aplicar';
  btnApply.onclick=applyWeights;
  footer.appendChild(btnApply);

  var btnReset=document.createElement('button');
  btnReset.style.cssText='padding:8px 14px;border-radius:5px;border:1px solid rgba(255,255,255,.1);background:#222;color:#888;font-size:12px;cursor:pointer';
  btnReset.textContent='Reset';
  btnReset.onclick=resetWeights;
  footer.appendChild(btnReset);

  var btnClose=document.createElement('button');
  btnClose.style.cssText='padding:8px 14px;border-radius:5px;border:1px solid rgba(255,255,255,.1);background:#222;color:#888;font-size:12px;cursor:pointer';
  btnClose.textContent='Fechar';
  btnClose.onclick=function(){overlay.remove()};
  footer.appendChild(btnClose);

  box.appendChild(footer);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function applyWeights(){
  Object.keys(DEFAULT_WEIGHTS).forEach(function(k){
    var el=document.getElementById('w_'+k);
    if(el)scoreWeights[k]=parseInt(el.value,10);
  });
  try{localStorage.setItem('radar_weights',JSON.stringify(scoreWeights))}catch(e){}
  // Recalcula scores de todas as tabs
  ['global','brasil','tech','crypto'].forEach(function(t){
    if(tabs[t].items)tabs[t].items.forEach(function(x){x.marcoScore=marcoScore(x)});
  });
  renderAll();
  document.getElementById('weights-modal').remove();
  showToast('Pesos aplicados — ranking atualizado','ok');
}

function resetWeights(){
  scoreWeights=Object.assign({},DEFAULT_WEIGHTS);
  Object.keys(DEFAULT_WEIGHTS).forEach(function(k){
    var el=document.getElementById('w_'+k);
    if(el){el.value=DEFAULT_WEIGHTS[k];document.getElementById('wv_'+k).textContent=DEFAULT_WEIGHTS[k]}
  });
}


// ─── FEATURE 6: HISTORICO DE LEITURA ─────────────────────────────────────────
var readItems={};
(function(){
  try{
    var raw=localStorage.getItem('radar_read');
    if(raw){
      var data=JSON.parse(raw);
      // Limpa itens com mais de 7 dias
      var week=7*24*60*60*1000;
      Object.keys(data).forEach(function(k){if(Date.now()-data[k]>week)delete data[k]});
      readItems=data;
    }
  }catch(e){}
})();

function markRead(id){
  readItems[id]=Date.now();
  try{localStorage.setItem('radar_read',JSON.stringify(readItems))}catch(e){}
}

function isRead(id){return !!readItems[id]}

function getReadCount(){return Object.keys(readItems).length}

function updateReadBadge(){
  var el=document.getElementById('read-count');
  if(el){
    var count=getReadCount();
    el.textContent=count>0?count+' lidos hoje':'';
    el.style.display=count>0?'block':'none';
  }
}


// Auto-refresh background tabs a cada 20min
async function bgRefreshOtherTabs(){
  var tabKeys=['global','brasil','tech','crypto'];
  for(var i=0;i<tabKeys.length;i++){
    var t=tabKeys[i];
    if(t===activeTab)continue;
    var ts=lastLoad[t];
    if(!ts||(Date.now()-ts>CACHE_TTL)){
      try{
        var fetches=TAB_FETCHES[t];
        var res=await Promise.allSettled(fetches.map(function(f){return f()}));
        var items=[];
        for(var j=0;j<res.length;j++){if(res[j].status==='fulfilled')items=items.concat(res[j].value)}
        var seen={};items=items.filter(function(x){if(seen[x.url])return false;seen[x.url]=1;return true});
        items.forEach(function(x){x.marcoScore=marcoScore(x)});
        var prevCache=loadTabCache(t)||[];
        var prevUrls={};prevCache.forEach(function(x){prevUrls[x.url]=1});
        var newCount=items.filter(function(x){return !prevUrls[x.url]}).length;
        saveTabCache(t,items);
        tabs[t].items=items;tabs[t].loaded=true;lastLoad[t]=Date.now();
        document.getElementById('tc-'+t).textContent=items.length+(newCount>0?' +'+newCount:'');
        if(newCount>0){
          var el=document.getElementById('tc-'+t);
          if(el){el.style.background='rgba(74,222,128,.2)';el.style.color='var(--green)'}
        }
      }catch(e){}
    }
  }
}
setInterval(bgRefreshOtherTabs, CACHE_TTL);


// ── THUMB CACHE (favicon + og image) ────────────────────────────────────────
var thumbCache = {};
function getThumb(item, cb) {
  var id = item.id;
  if (thumbCache[id] !== undefined) { cb(thumbCache[id]); return; }
  // Reddit items: usa thumbnail se disponível (vem no item)
  if (item.thumb && item.thumb !== 'self' && item.thumb !== 'default' && item.thumb !== 'nsfw' && item.thumb.startsWith('http')) {
    thumbCache[id] = item.thumb;
    cb(item.thumb);
    return;
  }
  // Tenta favicon via OG endpoint (async, não bloqueia render)
  var host = '';
  try { host = new URL(item.url || '').hostname; } catch(e) {}
  if (!host) { thumbCache[id] = null; cb(null); return; }
  var favUrl = 'https://www.google.com/s2/favicons?domain=' + host + '&sz=64';
  thumbCache[id] = favUrl;
  cb(favUrl);
}

// ── SOURCE AVATAR ────────────────────────────────────────────────────────────
function srcAvatar(label) {
  var colors = ['#4ade80','#60a5fa','#fb923c','#c084fc','#f87171','#fbbf24','#22d3ee'];
  var idx = label.split('').reduce(function(a,c){return a+c.charCodeAt(0)},0) % colors.length;
  return { color: colors[idx], letter: label.replace(/^r\//i,'').charAt(0).toUpperCase() || '?' };
}

// ── THUMB HTML ───────────────────────────────────────────────────────────────
function thumbHtml(item, w, h, radius) {
  var av = srcAvatar(item.label);
  var r = radius || '8px';
  var ww = w || 56; var hh = h || 56;
  var placeholder =
    '<div style="width:'+ww+'px;height:'+hh+'px;border-radius:'+r+';background:'+av.color+
    ';display:flex;align-items:center;justify-content:center;font-size:'+(ww>40?15:11)+
    'px;font-weight:800;color:#111;flex-shrink:0">'+av.letter+'</div>';
  if (item.thumb && item.thumb !== 'self' && item.thumb !== 'default' && item.thumb !== 'nsfw' && item.thumb.startsWith('http')) {
    return '<img src="'+esc(item.thumb)+'" width="'+ww+'" height="'+hh+
      '" style="border-radius:'+r+';object-fit:cover;flex-shrink:0;display:block" '+
      'onerror="this.outerHTML=\''+placeholder.replace(/'/g,"\\'").replace(/\n/g,'')+'\'">';
  }
  var host = ''; try { host = new URL(item.url||'').hostname; } catch(e) {}
  if (host) {
    var fav = 'https://www.google.com/s2/favicons?domain='+host+'&sz=64';
    if (ww >= 48) {
      return '<div style="width:'+ww+'px;height:'+hh+'px;border-radius:'+r+
        ';background:#222;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden">'+
        '<img src="'+fav+'" width="32" height="32" style="border-radius:4px" '+
        'onerror="this.parentElement.outerHTML=\''+placeholder.replace(/'/g,"\\'")+'\'"></div>';
    }
    return '<img src="'+fav+'" width="'+ww+'" height="'+hh+
      '" style="border-radius:'+r+';object-fit:cover;flex-shrink:0;background:#222" '+
      'onerror="this.outerHTML=\''+placeholder.replace(/'/g,"\\'")+'\'">'; 
  }
  return placeholder;
}

// ── CARD BUILDERS ────────────────────────────────────────────────────────────
function buildHeroCard(item) {
  var ms = item.marcoScore;
  var heatColor = item.heat==='hot'?'#f87171':item.heat==='rising'?'#fbbf24':'#60a5fa';
  var card = document.createElement('div');
  card.className = 'hero-card ' + item.heat + (isRead(item.id) ? ' is-read' : '');
  card.innerHTML =
    '<div class="hero-inner">'+
    '<div class="hero-thumb">'+thumbHtml(item, 72, 72, '10px')+'</div>'+
    '<div class="hero-body">'+
    '<div class="hero-eyebrow">'+
    '<span class="hero-topic" style="color:'+heatColor+'">'+esc(item.topic)+'</span>'+
    '<span class="hero-src-lbl">'+esc(item.label)+(item.score>0?' · +'+fmtScore(item.score):'')+' · '+item.age+'</span>'+
    (ms>=40?'<span class="marco-score '+(ms>=60?'hi':'mid')+' ms-badge" style="margin-left:auto">'+ms+'</span>':'')+
    '</div>'+
    '<div class="hero-title">'+esc(item.title)+'</div>'+
    (item.preview?'<div class="hero-preview">'+esc(item.preview)+'</div>':'')+
    '</div>'+
    '</div>';
  card.onclick = function() { openDrawer(item.id); };
  return card;
}

function buildGridCard(item) {
  var ms = item.marcoScore;
  var card = document.createElement('div');
  card.className = 'grid-card ' + item.heat + (isRead(item.id) ? ' is-read' : '');
  card.innerHTML =
    '<div class="grid-thumb-wrap">'+thumbHtml(item, '100%', 120, '6px 6px 0 0')+'</div>'+
    '<div class="grid-body">'+
    '<div class="grid-eyebrow">'+
    '<span class="grid-src">'+esc(item.label)+'</span>'+
    (ms>=30?'<span class="marco-score '+(ms>=50?'hi':'mid')+' ms-badge">'+ms+'</span>':'')+
    '</div>'+
    '<div class="grid-title">'+esc(item.title)+'</div>'+
    '<div class="grid-meta">'+item.age+(item.score>0?' · +'+fmtScore(item.score):'')+' </div>'+
    '</div>';
  card.onclick = function() { openDrawer(item.id); };
  return card;
}

function buildCompactItem(item) {
  var el = document.createElement('div');
  el.className = 'compact-item' + (isRead(item.id) ? ' is-read' : '');
  el.innerHTML =
    '<div class="compact-thumb">'+thumbHtml(item, 44, 44, '6px')+'</div>'+
    '<div class="compact-body">'+
    '<div class="compact-title">'+esc(item.title)+'</div>'+
    '<div class="compact-meta">'+esc(item.label)+' · '+item.age+(item.score>0?' · +'+fmtScore(item.score):'')+' </div>'+
    '</div>'+
    '<div class="compact-dot-wrap"><div class="compact-dot '+item.heat+'"></div></div>';
  el.onclick = function() { openDrawer(item.id); };
  return el;
}

// ── RENDER FEED ──────────────────────────────────────────────────────────────
function renderFeed() {
  var items = getSorted(getFiltered());
  var root = document.getElementById('feed-root');
  document.getElementById('feed-count').textContent = items.length + ' itens';
  if (!items.length) {
    root.innerHTML = '<div class="feed-empty"><p>Nenhum resultado</p><small>Tente outro filtro ou Atualizar</small></div>';
    return;
  }
  root.innerHTML = '';

  // HERO: top 2
  var heroSec = document.createElement('div');
  heroSec.className = 'hero-section';
  items.slice(0, 2).forEach(function(item) { heroSec.appendChild(buildHeroCard(item)); });
  root.appendChild(heroSec);

  // GRID: 3-8
  if (items.length > 2) {
    var gridLabel = document.createElement('div');
    gridLabel.className = 'section-label';
    gridLabel.textContent = 'Em alta';
    root.appendChild(gridLabel);
    var gridSec = document.createElement('div');
    gridSec.className = 'grid-section';
    items.slice(2, 8).forEach(function(item) { gridSec.appendChild(buildGridCard(item)); });
    root.appendChild(gridSec);
  }

  // COMPACT: resto
  if (items.length > 8) {
    var cLabel = document.createElement('div');
    cLabel.className = 'section-label';
    cLabel.textContent = 'Mais ' + (items.length - 8) + ' itens';
    root.appendChild(cLabel);
    var cList = document.createElement('div');
    cList.className = 'compact-list';
    items.slice(8).forEach(function(item) { cList.appendChild(buildCompactItem(item)); });
    root.appendChild(cList);
  }
}

// ─── TOAST ────────────────────────────────────────────────────────────────────
function showToast(msg,cls){
  var t=document.getElementById('toast');
  t.textContent=msg;t.className='toast on'+(cls?' '+cls:'');
  clearTimeout(t._t);t._t=setTimeout(function(){t.className='toast'},3500);
}

// ─── AUTO REFRESH ─────────────────────────────────────────────────────────────
setInterval(function(){
  var ts=lastLoad[activeTab];
  if(ts){
    var mins=Math.round((Date.now()-ts)/60000);
    var el=document.getElementById('last-update');
    if(el)el.textContent='Ha '+mins+'min';
    if(mins>=20)loadTab(true);
  }
},60000);

// ─── INIT ────────────────────────────────────────────────────────────────────
loadTab();
</script>
</body>
</html>